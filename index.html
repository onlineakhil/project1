<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Metro FPV Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100vw; transition: transform 0.3s linear; }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 8px;
      z-index: 999;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .controls button {
      display: block;
      margin: 4px 0;
      width: 100%;
    }
    .leaflet-rotate-text {
      transform: rotate(0deg);
    }
  </style>
</head>
<body>

<div class="controls">
  <button onclick="toggleFPV()">Toggle FPV Mode</button>
  <button onclick="toggleFollow()">Toggle Follow</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  const map = L.map('map', { zoomControl: false }).setView([12.99507, 77.75777], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const stations = [
    { name: "Whitefield (Kadugodi)", coords: [12.99507, 77.75777] },
    { name: "Hopefarm Channasandra", coords: [12.9995, 77.7420] },
    { name: "Kadugodi Tree Park", coords: [13.0010, 77.7310] },
    { name: "Pattandur Agrahara", coords: [13.0030, 77.7210] },
    { name: "Sri Sathya Sai Hospital", coords: [13.0040, 77.7120] },
    { name: "Nallurhalli", coords: [13.0050, 77.7040] },
    { name: "Kundalahalli", coords: [13.0065, 77.6965] },
    { name: "Seetharampalya", coords: [13.0080, 77.6890] },
    { name: "Hoodi", coords: [13.0100, 77.6800] },
    { name: "Garudacharpalya", coords: [13.0120, 77.6700] },
    { name: "Singayyanapalya", coords: [13.0140, 77.6620] },
    { name: "Krishnarajapura", coords: [13.0128, 77.6934] },
    { name: "Benniganahalli", coords: [13.0150, 77.6520] },
    { name: "Baiyappanahalli", coords: [13.0080, 77.6636] }
  ];

  const routeCoords = stations.map(s => s.coords);

  const route = L.polyline(routeCoords, { color: "purple", weight: 5 }).addTo(map);
  map.fitBounds(route.getBounds());

  // Direction arrows
  for (let i = 0; i < routeCoords.length - 1; i++) {
    const midLat = (routeCoords[i][0] + routeCoords[i+1][0]) / 2;
    const midLng = (routeCoords[i][1] + routeCoords[i+1][1]) / 2;
    const arrow = L.divIcon({ html: "➤", iconSize: [20, 20], className: "arrow-icon" });
    L.marker([midLat, midLng], { icon: arrow }).addTo(map);
  }

  stations.forEach(s => {
    L.marker(s.coords).bindPopup(`<b>${s.name}</b>`).addTo(map);
  });

  const metroIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/5193/5193754.png",
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  });

  let metroMarker = L.marker(routeCoords[0], { icon: metroIcon }).addTo(map);

  function interpolate(start, end, t) {
    const lat = start[0] + (end[0] - start[0]) * t;
    const lng = start[1] + (end[1] - start[1]) * t;
    return [lat, lng];
  }

  function calculateDistance(coord1, coord2) {
    const R = 6371e3;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(coord2[0] - coord1[0]);
    const dLon = toRad(coord2[1] - coord1[1]);
    const lat1 = toRad(coord1[0]);
    const lat2 = toRad(coord2[0]);

    const a = Math.sin(dLat/2)**2 +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return (R * c / 1000).toFixed(2); // in KM
  }

  let segment = 0, t = 0, step = 0.01;
  let lastStationShown = null;
  let followMode = true;
  let fpvMode = false;

  function updateMetro() {
    if (segment >= routeCoords.length - 1) {
      segment = 0;
      t = 0;
    }

    const start = routeCoords[segment];
    const end = routeCoords[segment + 1];
    const current = interpolate(start, end, t);

    metroMarker.setLatLng(current);
    if (followMode) map.setView(current);

    const dist = calculateDistance(current, end);
    const next = stations[segment + 1]?.name || "End";
    const prev = stations[segment]?.name || "N/A";

    if (lastStationShown !== next && dist < 0.3) {
      metroMarker.bindPopup(`
        <b>Next:</b> ${next}<br/>
        <b>Last:</b> ${prev}<br/>
        <b>Distance:</b> ${dist} km
      `).openPopup();
      lastStationShown = next;
    }

    t += step;
    if (t >= 1) {
      t = 0;
      segment++;
    }

    if (fpvMode) {
      const angle = Math.atan2(end[1] - start[1], end[0] - start[0]) * 180 / Math.PI;
      document.getElementById('map').style.transform = `rotate(${-angle + 90}deg)`;
    }
  }

  setInterval(updateMetro, 200);

  function toggleFPV() {
    fpvMode = !fpvMode;
    document.getElementById('map').style.transform = fpvMode ? 'rotate(0deg)' : 'rotate(0deg)';
  }

  function toggleFollow() {
    followMode = !followMode;
  }

  // User GPS Location
  const userIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });

  let userMarker = null;

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      if (!userMarker) {
        userMarker = L.marker(latlng, { icon: userIcon }).addTo(map)
          .bindPopup("You are here").openPopup();
      } else {
        userMarker.setLatLng(latlng);
      }
    }, err => console.log("GPS error:", err), {
      enableHighAccuracy: true
    });
  } else {
    alert("Geolocation is not supported.");
  }
</script>

</body>
</html>
