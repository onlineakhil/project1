<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vertical Metro FPV Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100vw; }

    #controlPanel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      padding: 10px;
      font-family: sans-serif;
      z-index: 999;
    }
    #followBtn {
      padding: 5px 10px;
      cursor: pointer;
      background: #6200ee;
      color: white;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="controlPanel">
  <button id="followBtn">Follow: ON</button>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  const map = L.map('map', {
    zoomControl: false
  }).setView([12.995, 77.75], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const stations = [
    { name: "Whitefield (Kadugodi)", coords: [12.99507, 77.75777] },
    { name: "Hopefarm Channasandra", coords: [12.9995, 77.7420] },
    { name: "Kadugodi Tree Park", coords: [13.0010, 77.7310] },
    { name: "Pattandur Agrahara", coords: [13.0030, 77.7210] },
    { name: "Sri Sathya Sai Hospital", coords: [13.0040, 77.7120] },
    { name: "Nallurhalli", coords: [13.0050, 77.7040] },
    { name: "Kundalahalli", coords: [13.0065, 77.6965] },
    { name: "Seetharampalya", coords: [13.0080, 77.6890] },
    { name: "Hoodi", coords: [13.0100, 77.6800] },
    { name: "Krishnarajapura", coords: [13.0128, 77.6934] },
    { name: "Garudacharpalya", coords: [13.0120, 77.6700] },
    { name: "Singayyanapalya", coords: [13.0140, 77.6620] },
    { name: "Benniganahalli", coords: [13.0150, 77.6520] },
    { name: "Baiyappanahalli", coords: [13.0080, 77.6636] }
  ];

  const routeCoords = stations.map(s => s.coords);
  const route = L.polyline(routeCoords, { color: "purple", weight: 5 }).addTo(map);
  map.fitBounds(route.getBounds());

  stations.forEach(station => {
    L.marker(station.coords).bindPopup(`<b>${station.name}</b>`).addTo(map);
  });

  const gpsIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/5193/5193754.png",
    iconSize: [32, 32],
    iconAnchor: [16, 16]
  });

  let gpsMarker = L.marker([0, 0], { icon: gpsIcon }).addTo(map);
  let followMode = true;

  document.getElementById('followBtn').addEventListener('click', () => {
    followMode = !followMode;
    document.getElementById('followBtn').textContent = `Follow: ${followMode ? 'ON' : 'OFF'}`;
  });

  function isClose(pos1, pos2, threshold = 0.0005) {
    return Math.abs(pos1[0] - pos2[0]) < threshold && Math.abs(pos1[1] - pos2[1]) < threshold;
  }

  let lastStationShown = null;

  function showLocation(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const currentPos = [lat, lon];

    gpsMarker.setLatLng(currentPos);

    if (followMode) map.panTo(currentPos);

    for (let i = 0; i < stations.length; i++) {
      if (isClose(currentPos, stations[i].coords) && lastStationShown !== stations[i].name) {
        const prevStation = stations[i - 1]?.name || "N/A";
        const nextStation = stations[i + 1]?.name || "End of Line";
        gpsMarker.bindPopup(`
          <b>Current Station:</b> ${stations[i].name}<br/>
          <b>Last Station:</b> ${prevStation}<br/>
          <b>Next Station:</b> ${nextStation}
        `).openPopup();
        lastStationShown = stations[i].name;
        break;
      }
    }
  }

  function errorHandler(err) {
    console.error("Geolocation error:", err);
    alert("Unable to retrieve your location.");
  }

  if ("geolocation" in navigator) {
    navigator.geolocation.watchPosition(showLocation, errorHandler, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    });
  } else {
    alert("Geolocation is not supported by your browser.");
  }
</script>

</body>
</html>
